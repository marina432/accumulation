

MULTI命令可以将执行该命令的客户端从非事务状态切换至事务状态，切换至事务状态后，服务器会根据这个客户端发来的命令是否是（"EXEC", "DISCARD","WATCH","MULTI"）四种命令之一，而执行以下两种不同的操作：  
- 如果是，则服务器立即执行这个命令  
- 如果不是，那么服务器并不立即执行这个命令，而是将其放入一个事务队列（FIFO）里，然后向客户端返回QUEUE回复。  


### 事务队列  
每个Redis客户端都有自己的事务状态，这个事务状态保存在（Redis服务器上的）客户端状态的mstate属性里。
mstate属性的机构体里包含一个事务队列（先进先出），以及一个已入队命令的计数器。  

### 执行事务  
当服务器接收到处于事务状态的客户端发来的EXEC命令时，会立即执行EXEC命令。EXEC命令执行过程如下：  
   1. 服务器会先检查该客户端的REDIS_DIRTY_CAS标识是否打开，
如果是，服务器将拒绝执行事务，并向客户端返回事务执行失败的空回复；  
   2. 如果不是，则服务器会遍历该客户端的事务队列，依次执行保存的所有命令，并将执行结果全部返回给客户端。  

### WATCH命令
每个redis数据库都保存这一个watched_keys字典：  
- 字典的键：某个被WATCH监视的数据库键  
- 字典的值：是一个链表，记录所有监视该键的客户端  

#### 监视机制的触发  
所有对数据库进行修改的命令，在执行后都会调用multi.c/touchWatchKey函数对watched_keys字典进行检查，查看是否有客户端正在监视刚刚被自己（命令）修改过的数据库键。
如果有，touchWatchKey函数会将变更设计的相关监视客户端的REDIS_DIRTY_CAS标识打开，以表示该客户端的事务安全性已经被破坏。


### 完整的Redis事务执行流程
```shell
WATCH "key1" "key2" ...   #加乐观锁
MULTI   #切换到事务状态
...   #省略多命令
#DISCARD   #放弃事务，清空事务队列
#SAVE   #用于保证事务的持久性，不过这种做法效率太低，所以并不具有实用性 
EXEC    #执行事务
```

### Reids事务的ACID性质  
Redis的事务总是觉有原子性、一致性、隔离性，
当服务器运行在AOF持久化模式下，并且appendfsync选项的值为always时，事务也具有持久性。