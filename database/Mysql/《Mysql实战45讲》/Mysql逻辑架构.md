### Mysql基本（逻辑）架构  
Mysql架构基本可以分为两层：Server层+存储引擎层  
#### 一. Server层  
Server层涵盖Mysql的大多数核心服务功能，以及所有的内置函数（如日期、时间、数据），所有跨存储引擎的功能都在这一层，如存储引擎、触发器、视图等。  
Server层构成如下（按sql执行流程列出）：  
1. 连接器  
> 负责跟client建立（TCP）连接、获取权限、维持及管理连接。
> ps：这里的权限粒度比较粗，只是通过用户名获取有无访问数据库的权限。后面分析器（在语法分析后）、执行器（在执行sql前），会通过用户名查询有无操作相应表的权限，这个粒度到表、到操作。

具体工作：TCP连接建立后，验证用户名密码。验证通过后，连接器会到权限表查询对应用户所拥有的权限（之后，这个连接里的权限判断逻辑，都依赖此时读到都权限，不会变更）。
连接完成后，如果没有后续动作，这个连接就处于空闲状态，可以用show processlist命令看到它。  
客户端如果长时间没动静，连接器就负责将该连接断开。这个时间由参数wait_timeout控制，默认是8h。  

- 数据库长连接：指连接建立成功后，如果客户端持续请求，则一直使用同一个连接。
- 数据库短连接：指连接建立成功后，每次只执行几次请求就断开连接，下次查询再重新建立连接。  
> 鉴于连接建立都过程较复杂，所以建议尽量减少建立连接的动作，使用长连接。-连接池化。  
> 然而，也有问题：在全部使用长连接后，会发现有些时候Mysql占用的内存涨得特别快？  
> - 原因是：Mysql在执行过程中临时使用的内存是管理在连接对象里面的，这些资源只有在连接断开时才能释放。所以，长连接累积下来，
> 可能导致Mysql占用内存太大（OOM），被系统强行杀掉，从现象看就是Mysql异常重启来。  
> - 解决方案：1. 定期断开连接。（使用一段时间就断开+程序里判断执行过一个占用内存的大查询后就断开）；  
>           2. 通过mysql_reset_connection重新初始化连接资源（Mysql5.7及以后版本支持）。（无需重连，无需重做权限验证，只是将连接回复到刚刚创建完到状态）


2. 查询缓存（Mysql 8.0已移除本功能，可参阅：https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/）  
> 8.0版本以下Mysql，可能会将执行过的sql语句及结果以key-value对的形式缓存在内存中。当Mysql拿到一个查询请求后，会先查询该缓存，
   如果按sql找到key，则在做完权限验证通过后，就直接将value返回。如果找不到，则走到分析器。  
- 大多数不建议使用查询缓存，因为弊大于利：  
> 缓存失效非常频繁，只要对该表有更新操作，这个表上对所有查询缓存都会被清空（--Mybatis的一级session缓存也是这样的）。
> 如果是更新压力大的数据库，那么查询缓存的命中率回非常低。  

3. 分析器-明确要做什么，以及确定要不要做（如果precheck权限验证通过，则确定要做）  
- 词法分析：分析器要识别出sql中的每个字符串是什么，代表什么。  
- 语法分析：根据词法分析的结果及语法规则，判断sql是否满足Mysql语法。（返回错误提示中，关注"use near"后的内容）  

4. 优化器-确定怎么做  
作用：决定使用哪一种方案。
> 比如：表里有多个索引时，决定是否使用索引；使用索引的话，又应该使用哪一个。（关于优化器是如何选择索引的可参看：XXX）  
> 又比如：多表关联的时候，决定各表的连接顺序。

5. 执行器  
> 由于分析器阶段结尾的precheck，无法对运行时涉及到的表进行权限验证（eg.使用触发器的情况），因此在执行器开始执行后，
> 它首先要进行权限验证。指有有权限，才能打开表继续执行。  
> 打开表的时候，执行器会根据表的引擎定义（engin=InnoDB/Memory/MyISAM），去使用这个引擎提供的API接口。（因此说，数据库引擎是插拔式的）  

执行器每次调用相应的存储引擎接口，获取到一条满足条件的数据，如此反复，知道获取到所有满足条件的数据。  
> 在数据库的慢查询日志（如何开启参看：https://www.yuque.com/mona432/rsb8ye/go27cd）中：
> - rows_examined：表示语句执行过程中扫描了多少行（执行器的扫描次数）。该值就是在执行器每次调用存储引擎获取数据行的时候累加的（即：执行器每调用一次存储引擎，rows_examined++）。  
> ps：有时，执行器调用一次，存储引擎要扫描多行才，因此执行器扫描次数永远<=引擎扫描次数。  
> 关于存储引擎的内部机制参看：XXX


#### 二. 存储引擎层  
本层负责数据的存储和提取。且架构模式是插拔式的，支持InnoDB，MyISAM，Memery等多个存储引擎。  
从Mysql 5.5.5版本开始，InnoDB已成为默认存储引擎。  
> 索引和事务都是在存储引擎层实现的。  

