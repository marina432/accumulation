
## 一、事务的四个场景
### 1.1本地事务(单个事务使用单个数据源)
> 本地事务定义：指仅操作特定单一数据源的、不需要"全局事务管理器"进行协调的事务。

本地事务的开启、终止、提交、回滚、嵌套、设置隔离级别、乃至与应用代码贴近的传播方式，全部都要依赖底层数据库的支持。

奔溃恢复(crash recovery)  
1. 未提交事务  
2. 已提交事务

通过日志实现事务的原子性和持久性是当今的主流方案，但并非唯一方案，诸如"Shadow Paging(影子分页}"也可以实现。
Shadow Paging的关键不足是：一个page上的数据同一时间只能不同一事务修改，导致串行度太高，因此并发效率较低。

#### 事务的实现方式
1. Commit Logging  
- 在日志(Redo Log)记录全部都安全落盘后
- 在见到代表事务成功提交的"record commit"后
- 数据库才会根据日志(Redo Log)上的信息进行数据落盘
- 数据罗盘完成后，在日志中加入一条"End Record"表示该事务已完成持久化

Commit Logging实现方式缺陷：数据罗盘必须发上在事务commit之后。为了解决这个缺陷ARIES理论提出了"Write-Ahead Logging"的日志改进方案，允许在事务提交之前，提前写入变动数据。  

2. WAL(Write-Ahead Logging)  
将何时将变动数据落盘，以事务提交时点为界，分为"FORCE"和"STEAL"两类：
> FORCE：当事务提交后，要求变动数据必须同时完成写入则称为 FORCE，如果不强制变动数据必须同时完成写入则称为 NO-FORCE。现实中绝大多数数据库采用的都是 NO-FORCE 策略，只要有了日志，变动数据随时可以持久化，从优化磁盘 I/O 性能考虑，没有必要强制数据写入立即进行。  
> 
> STEAL：在事务提交前，允许变动数据提前写入则称为 STEAL，不允许则称为 NO-STEAL。从优化磁盘 I/O 性能考虑，允许数据提前写入，有利于利用空闲 I/O 资源，也有利于节省数据库缓存区的内存。  

Commit Logging允许NO-FORCE，但不允许STEAL。  
WAL则允许NO-FORCE，也允许STEAL。它通过增加Undo Log日志，解决了commit前罗盘数据但回滚问题：当变动数据写入磁盘前，要先写Undo Log，写明修改哪个位置都数据，从什么值改为什么值，以便在事务回滚或崩溃恢复时，根据Undo Log对提前写入磁盘对数据变动进行擦除。

由于Undo Log的加入，WAL在崩溃恢复时要经历以下三个阶段：  
> 分析阶段（Analysis）：该阶段从最后一次检查点（Checkpoint，可理解为在这个点之前所有应该持久化的变动都已安全落盘）开始扫描日志，找出所有没有 End Record 的事务，组成待恢复的事务集合（一般包括 Transaction Table 和 Dirty Page Table）。  
> 
> 重做阶段（Redo）：该阶段依据分析阶段中，产生的待恢复的事务集合来重演历史（Repeat History），找出所有包含 Commit Record 的日志，将它们写入磁盘，写入完成后增加一条 End Record，然后移除出待恢复事务集合。  
> 
> 回滚阶段（Undo）：该阶段处理经过分析、重做阶段后剩余的恢复事务集合，此时剩下的都是需要回滚的事务（被称为 Loser），根据 Undo Log 中的信息回滚这些事务。


###远程事务





###附：
####附1：现代数据库三种锁
1. 写锁(X-Lock)--排它
2. 读锁(S-Lock)--共享，如果某数据只被某一事务加持读锁，则该读锁可直接升级为写锁，升级后可对该数据执行写入操作
3. 范围锁(Range-Lock)
####附2：事务的隔离级别  
读未提交：事务读取数据时无需加读锁，直接读即可。  
读已提交：要求事务中，每次读取数据时，先要对数据加读锁，并且在读取完后，立即释放该读锁，即：该锁读时效是一次读取。  
可重复读：同"读已提交"，要求事务中在读取数据前先加读锁后才可读取数据，不同点是：该读锁读时效是持续到事务提交或回滚完成。  
可串行化：要求事务中，读取数据时前加读锁和范围锁(间隙锁)后才可读取数据，并且读锁和间隙锁到实效都是持续到事务提交或回滚完成。  






###参考阅读：  
1. mysql的删除操作其实时假删除：https://zhuanlan.zhihu.com/p/66336976           优化：optimize table t;
2. 【MySQL】一条update语句的生命周期：https://zhuanlan.zhihu.com/p/142165678
3. 
