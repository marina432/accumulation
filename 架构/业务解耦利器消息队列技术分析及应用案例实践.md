[TOC]目录
### 一、企业级消息队列应用场景深入分析  
应用场景：
- 解耦核心业务与运营业务  
- 各业务线对消息接收方自定义逻辑  

消息队列主要作用：
1. 业务解耦  
   - 提升系统稳定性（RPC 最常见的问题是“系统的雪崩”--此需要熔断降级过载保护）  
    - 通过广播消息避免多次调用  
    - 提高编码效率  
    > 思考：
   > MQ 能否完全取代 RPC ？  
2. 异步调用  
   - RPC 风控拦截  
    - RPC 扣减库存  
    - 异步通知卖家  
    - 异步记录数据  
3. 流量削峰（填谷）  


### 二、Apache RocketMQ 消息队列整体架构深入剖析  
#### 2.1 RocketMQ 拓扑图：
- Name Server  
  > 特点：各节点互不相连，不做数据同步，却又都存储全量注册信息（ps：全靠broker心跳实现）。  
- Broker  
  > 特点：各 Broker 组内，只 Broker Master 负责接收写请求，然后数据从 Broker Master 同步到 Broker Slave。  
- Producer  
  > 特点：各节点互不相连。  
- Consumer  
  > 特点：各节点互不相连。  
ps：
> 消息生产者只连接 Broker Master  
> 消息消费者连接 Broker Master 及 Broker Slave  

#### 2.2 数据的可靠性与服务的可用性  
##### 2.2.1 数据的可靠性  
1. 生产方式  
- 同步  --效率低一些，但可靠性高
- 异步  --效率高，单有可能造成业务逻辑的错乱  
- 单向  --无可靠性  

2. 刷盘方式  
- 同步刷盘  --可靠性高  
- 异步刷盘  --做聚合，批量I/O，I/O性能高，缺点：有可能丢数据  

3. 复制方式  
- 同步双写（复制）  --可靠性高  
- 异步复制  

ps：
> 实际生产中，要做可靠性与性能的平衡  

##### 2.2.2 服务的可用性  
1. 单主模式
2. 主从模式  
3. 多主模式  --多对主从，生产环境建议使用  

ps：
> 注意区分：存储的冗余 & 服务的冗余  

#### 2.3 消费方式  
1. push  --消息队列主动地将消息推送给消费者  
> 特点：消息实时性高，但没有考虑客户端的消费能力  
2. pull  --由消费者主动地从消息队列拉取消息  
> 特点：取决于拉的频率，如果拉的频率低，则消息的实时性低；如果拉的频率高，则可能造成大量的无效请求  
3. longpull  --介于 push 与 pull 之间的方式  

ps：从消息路由方式分，又可分为以下两种消费方式：
1. 集群消费  
   > 集群内竞争消费，单条消息只消费一次，各节点均匀消费 Topic 的消息  
2. 广播消费  
   > 各集群消费全量的消息，单条消息在每个集群都会被消费一次  
   > 
> ps：Group内竞争，Group间广播

### 三、Apache RocketMQ 消息队列核心技术及工作原理剖析  
#### 3.1 消息存储  
- CommitLog：存储消息主体  
- ConsumeQueue：消息消费队列  
- IndexFile：消息索引文件  

> 问题1：顺序写、随机读，如何保证消费性能？  
> 1. SSD  
> 2. commitLog 按大小切割  
> 3. MMap(Memory Map)内存映射  

ps：组内，一个队列只能被一个消费者消费。  

#### 3.2 客户端负载均衡  
1. 客户端心跳上报数据  
2. 定时 Rebalance /20s
- 获取队列信息  
- 获取消费者信息  
- 排序平均分配  
- 与上次结果对比  

> 问题2：队列与消费者如何分配？  

### 四、Apache RocketMQ高级特性-企业级应用场景分析  
#### 4.1 RockerMQ 高级特性  
1. 消息重发  
- 消息失败重试策略  
    1. 重试 16 次  
    2. 重试时间间隔递增  
    3. 失败进入死信队列

- 实现原理  
    1. 自动创建失败消息主题  
    2. 客户端默认订阅  
    3. 结合延时消息实现重试间隔  

2. 事务型消息  
ps：解决的是本地事务与发消息的原子性问题。  
   
RocketMQ 事务消息机制：  
- 发送半消息  
- 执行本地事务  
- 发送 Commit/Rollback  
- 提供回查接口  

3. 延时消息  

4. 顺序消息  

