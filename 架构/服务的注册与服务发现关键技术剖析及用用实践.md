[TOC]目录

分布式系统考虑的侧重点是扩展性。
### 一、微服务架构中服务注册核心技术剖析及实践   
注册中心作用：服务端去做服务注册，客户端去做服务发现。   
1. 数据存储  
- 存储内容 
  > 节点路由信息  
  > RPC调用辅助信息  
- 存储结构  
  > KV结构   
  > KList结构  
  > 树状结构（eg. zk）
- 存储方式（内存 or 固化， 内置 or 外置）  
> 是否固化需求？  
> 是否借助外部存储系统？  

2. 一致性  
- 主从模式：主从同步(存在主从延时问题)  
  > MySQL/Redis 存储，主从同步提供数据一致性保障  
- 副本集模式：多副本同步（一致性协议<zab协议或raft协议> or 广播<数据一致性低，但效率高>）  
> etcd/Zookeeper，一致性协议同步，保障数据最终一致性。  

3. 可靠性  
- 数据可靠性（不丢失）  
- 服务可用性  
> 在使用外置存储的情况下，服务的可用性保障：
> - 多节点冗余部署  
> - 集群自动发现  
> - 节点选主  

4. 准确性  
- 超时过期淘汰  
- 节点探活--防止模块假死  
> 服务注册节点准确性保障：  
> - 心跳保活  
> - 长连接  
> - 探活协议  

### 二、微服务架构中服务发现核心技术剖析与实践  
1. 拉取时机--即：维护调用列表问题。  
> - 启动拉取：客户端启动时向注册中心发起请求，拉取服务路由信息。  
> - 定时拉取：客户端启动后定时向注册中心发起请求，获取数据变更。  
> - 变更通知（服务订阅）：客户端接受服务端推送的变更通知/数据，实时获取变更。

2. 正向调用列表与反向调用列表  


### 三、CAP定理企业应用案例--注册中心AP与CP的优雅选择  
- C--数据一致性  
- A--服务可用性  
- P--分区容错性  

注册中心选型：
- AP--牺牲一致性，继续提供服务
  > eg. Eureka  
- CP--牺牲可用性，待恢复一致性状态后提供服务  
> eg. Zookeeper  
ps:
> 注册中心的理想选型是AP
> 现实中，注册中心也有采用CP(eg.zookeeper)，是因为客户端会缓存服务调用列表，在注册中心不可用时，客户端依然可以从自己的缓存中
> 获得服务调用列表，从而进行服务调用。  



### 四、Ereaka AP 注册中心原理剖析以及应用实践  
> Eureka 使用广播方式做 Eureka Server 各副本间的数据同步，并且数据在 Eureka Server 中是做内存存储的。当某一个 Eureka Server 发生
重启时，会直接从其他 Eureka Server 节点拉取数据到内存。  
> Eureka 是 Netflix 开发的基于 REST 服务发现框架，不过 2.0 已经闭源。  
> 服务消费方（Eureka 客户端）拉取数据时机只在其启动时以及定时拉取，所以 Eureka 客户端拉取数据实时性不是太好。  
> 服务提供方（Eureka 客户端）向 Eureka Server 进行注册/注销、以及定时发送心跳。  
> Eureka Server 定时做超时服务的扫描，从而剔除心跳超时的不正常服务。  

Eureka：  
#### 4.1 数据存储  --分层设计  
- 缓存层   --类比Redis  
> - 一级缓存（外部数据结构）  --只读缓存（readOnlyCacheMap），定时从二级缓存同步数据  
> - 二级缓存  --读写缓存（readWriteCacheMap），涉及缓存失效与缓存淘汰策略
- 存储层（内部存储，实时数据）  --类比MySQL  
> 存储服务节点数据，数据结构--两层Map      --本层会做心跳超时扫描  

ps：
> Eureka 全部都是内存数据  
> 思考：二级缓存的意义？  
>> 1. 隔离内部数据存储与外部数据结构。  
>> 2. 实现读写分离（从而避免加锁操作），提高并发。  

#### 4.2 服务注册与注销  

#### 4.3 服务续约--更新TTL  
> 所有 Eureka Server 中该微服务的TTL都要更新，而 Eureka Server 间会以广播方式同步 TTL，所以会造成写入放大问题。  

#### 4.4 数据淘汰  

#### 4.5 服务发现  

#### 4.6 数据同步  










